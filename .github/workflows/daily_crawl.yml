name: æ¯æ—¥æ ¡åœ’è³‡æ–™æ›´æ–° (Daily Crawl)

# è¨­å®šè§¸ç™¼æ™‚æ©Ÿ
on:
  # 1. è‡ªå‹•æ’ç¨‹ï¼šæ¯å¤© UTC 22:00 (å°ç£æ™‚é–“æ—©ä¸Š 06:00)
  schedule:
    - cron: '0 22 * * *'
  
  # 2. æ‰‹å‹•è§¸ç™¼ï¼šå…è¨±åœ¨ GitHub ç¶²é  Actions é é¢æŒ‰æŒ‰éˆ•åŸ·è¡Œ
  workflow_dispatch:

# âš ï¸ é—œéµæ¬Šé™è¨­å®šï¼šå…è¨± GitHub Action ä¿®æ”¹ä¸¦ä¸Šå‚³æª”æ¡ˆ
permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    # ---------------------------------------------------
    # æ­¥é©Ÿ 1: ä¸‹è¼‰æ‚¨çš„ç¨‹å¼ç¢¼
    # ---------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # ---------------------------------------------------
    # æ­¥é©Ÿ 2: è¨­å®š Python ç’°å¢ƒ (3.10)
    # ---------------------------------------------------
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # ---------------------------------------------------
    # æ­¥é©Ÿ 3: å®‰è£çˆ¬èŸ²éœ€è¦çš„å¥—ä»¶ (å« Playwright ä¿®å¾©)
    # ---------------------------------------------------
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        
        # å®‰è£çˆ¬èŸ²èˆ‡è³‡æ–™è™•ç†éœ€è¦çš„ Python åº«
        # (é€™è£¡åˆ—å‡ºäº†æ‚¨ç¨‹å¼å¯èƒ½ç”¨åˆ°çš„æ‰€æœ‰å¸¸è¦‹çˆ¬èŸ²å¥—ä»¶)
        pip install requests beautifulsoup4 pandas lxml playwright nest_asyncio google-genai
        
        # âš ï¸ã€é—œéµä¿®å¾©ã€‘å®‰è£ Playwright çš„ç€è¦½å™¨æ ¸å¿ƒ (Chromium)
        # æ²’æœ‰é€™ä¸€è¡Œï¼Œé›²ç«¯åŸ·è¡Œæœƒå ±éŒ¯ TargetClosedError
        playwright install chromium

    # ---------------------------------------------------
    # æ­¥é©Ÿ 4: ä¾åºåŸ·è¡Œä¸‰å€‹ç¨‹å¼
    # ---------------------------------------------------
    - name: Run Crawlers and Merge
      env:
        # å¦‚æœæ‚¨çš„çˆ¬èŸ²æœ‰ç”¨åˆ° API Keyï¼Œè«‹åœ¨ GitHub Secrets è¨­å®šï¼Œä¸¦åœ¨é€™è£¡å¼•å…¥
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        echo "ğŸ•·ï¸ [1/3] é–‹å§‹åŸ·è¡Œéœæ…‹çˆ¬èŸ² (Static Crawler)..."
        python static_crawler_v43_recursive.py
        
        echo "ğŸ•·ï¸ [2/3] é–‹å§‹åŸ·è¡Œå‹•æ…‹çˆ¬èŸ² (Playwright Bot Builder)..."
        # æ³¨æ„ï¼šPython ç¨‹å¼å…§å¿…é ˆè¨­å®š headless=True æ‰èƒ½åœ¨é›²ç«¯è·‘
        python ultimate_bot_builder_v40_printHere.py
        
        echo "ğŸ”„ [3/3] é–‹å§‹æ•´åˆè³‡æ–™ (Merge Data)..."
        python merge_data.py

    # ---------------------------------------------------
    # æ­¥é©Ÿ 5: æª¢æŸ¥è®Šæ›´ä¸¦ä¸Šå‚³ (Push) - å¼·åŠ›é™¤éŒ¯ç‰ˆ
    # ---------------------------------------------------
    - name: Commit and Push changes
      run: |
        # 1. è¨­å®šæ©Ÿå™¨äººèº«åˆ†
        git config --global user.name "GitHub Action Bot"
        git config --global user.email "actions@github.com"
        
        # 2. [é™¤éŒ¯] å°å‡ºç›®å‰ç›®éŒ„ä¸‹çš„æª”æ¡ˆï¼Œè­‰æ˜ json çœŸçš„å­˜åœ¨
        echo "ğŸ” [Debug] åˆ—å‡ºç•¶å‰ç›®éŒ„æª”æ¡ˆ (æª¢æŸ¥ nihs_knowledge_full.json æ˜¯å¦å­˜åœ¨)..."
        ls -lh nihs_knowledge_full.json || echo "âŒ æ‰¾ä¸åˆ°æª”æ¡ˆï¼"
        
        # 3. å¼·åˆ¶åŠ å…¥æª”æ¡ˆ
        git add nihs_knowledge_full.json
        
        # 4. [é™¤éŒ¯] å°å‡º Git ç‹€æ…‹ï¼Œç¢ºèªæ˜¯å¦æœ‰æ±è¥¿è¢« Stage
        echo "ğŸ” [Debug] Git Status:"
        git status
        
        # 5. æäº¤èˆ‡æ¨é€
        timestamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        # å˜—è©¦æäº¤ï¼Œå¦‚æœæ²’æœ‰è®Šæ›´ (git commit å›å‚³é 0) å‰‡å°å‡ºè¨Šæ¯ä½†ä¸å ±éŒ¯
        if git commit -m "Auto-update data: ${timestamp}"; then
          echo "âœ… æäº¤æˆåŠŸï¼Œæº–å‚™æ¨é€..."
          git push
          echo "ğŸš€ æ¨é€å®Œæˆï¼GitHub æª”æ¡ˆæ‡‰å·²æ›´æ–°ã€‚"
        else
          echo "âš ï¸ Git å›å ±æ²’æœ‰è®Šæ›´ (Nothing to commit)ï¼Œå¯èƒ½æ˜¯æª”æ¡ˆå…§å®¹å®Œå…¨æ²’è®Šã€‚"
        fi
