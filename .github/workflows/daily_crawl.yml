name: æ¯æ—¥æ ¡åœ’è³‡æ–™æ›´æ–° (Daily Crawl)

# ==========================================
# â° è§¸ç™¼æ™‚æ©Ÿè¨­å®š
# ==========================================
on:
  # 1. è‡ªå‹•æ’ç¨‹ï¼šå°ç£æ™‚é–“å‡Œæ™¨ 03:00 (UTC 19:00)
  schedule:
    - cron: '0 19 * * *'
  
  # 2. æ‰‹å‹•è§¸ç™¼ (åœ¨ GitHub Actions é é¢æ‰‹å‹•æŒ‰)
  workflow_dispatch:

# âš ï¸ æ¬Šé™è¨­å®šï¼šè³¦äºˆå¯«å…¥æ¬Šé™ä»¥ä¾¿ Push å› GitHub
permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    # ---------------------------------------------------
    # 1. ç’°å¢ƒæº–å‚™
    # ---------------------------------------------------
    - name: æª¢å‡ºå„²å­˜åº« (Checkout)
      uses: actions/checkout@v4
      with:
        # âš ï¸ é—œéµï¼šæŠ“å–å®Œæ•´ Git æ­·å²ç´€éŒ„ï¼Œç¢ºä¿ Rebase é‹ä½œæ­£å¸¸
        fetch-depth: 0

    - name: è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: å®‰è£å¿…è¦å¥—ä»¶ (Dependencies)
      run: |
        python -m pip install --upgrade pip
        # âš ï¸ ä¿®æ­£ï¼šåŒæ™‚å®‰è£ google-genai èˆ‡ google-generativeai
        pip install requests beautifulsoup4 pandas lxml playwright nest_asyncio google-genai google-generativeai pdfplumber
        playwright install chromium

    # ---------------------------------------------------
    # 2. åŸ·è¡Œçˆ¬èŸ²èˆ‡è³‡æ–™è™•ç† (é‚è¼¯å„ªåŒ–ç‰ˆ)
    # ---------------------------------------------------
    - name: åŸ·è¡Œçˆ¬èŸ²ã€æ•´åˆèˆ‡ AI å¢å¼·
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        # --- æ­¥é©Ÿ A: éœæ…‹çˆ¬èŸ² (æ¯é€±ä¸€æ¬¡ç­–ç•¥) ---
        # å–å¾—ä»Šå¤©æ˜¯æ˜ŸæœŸå¹¾ (0=é€±æ—¥)
        DAY_OF_WEEK=$(date +%w)
        
        # é‚è¼¯ï¼šå¦‚æœæ˜¯é€±æ—¥(0) æˆ–è€… æ˜¯æ‰‹å‹•è§¸ç™¼(workflow_dispatch)ï¼Œæ‰è·‘éœæ…‹çˆ¬èŸ²
        if [ "$DAY_OF_WEEK" -eq "0" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "ğŸ“… ä»Šå¤©æ˜¯é€±æ—¥ (æˆ–æ‰‹å‹•è§¸ç™¼)ï¼ŒåŸ·è¡Œå…¨é‡éœæ…‹çˆ¬èŸ²..."
          python static_crawler_v43_recursive.py || echo "âš ï¸ éœæ…‹çˆ¬èŸ²ç•°å¸¸ï¼Œå°‡ä½¿ç”¨èˆŠæª”..."
        else
          echo "ğŸ’¤ ä»Šå¤©ä¸æ˜¯é€±æ—¥ï¼Œè·³ééœæ…‹çˆ¬èŸ² (ä½¿ç”¨ Repository ä¸­ç¾å­˜çš„èˆŠæª”)ï¼Œç¯€çœè³‡æºã€‚"
        fi
        
        # --- æ­¥é©Ÿ B: å‹•æ…‹å…¬å‘Šçˆ¬èŸ² (æ¯æ—¥å¿…è·‘) ---
        echo "ğŸ•·ï¸ [2/6] åŸ·è¡Œå‹•æ…‹å…¬å‘Šçˆ¬èŸ²..."
        python ultimate_bot_builder_v40_printHere.py || echo "âš ï¸ å‹•æ…‹çˆ¬èŸ²ç•°å¸¸..."
        
        # --- æ­¥é©Ÿ C: é™„å±¬è³‡æ–™ç”Ÿæˆ ---
        echo "ğŸ§  [3/6] ç”Ÿæˆ FAQ é¡Œåº«..."
        python generate_faq.py || echo "âš ï¸ FAQ ç”Ÿæˆå¤±æ•—..."
        
        echo "ğŸ“… [4/6] è§£æè¡Œäº‹æ›† PDF..."
        python generate_calendar.py || echo "âš ï¸ è¡Œäº‹æ›†è§£æå¤±æ•—..."
        
        # --- æ­¥é©Ÿ D: è³‡æ–™æ•´åˆ (Merge) ---
        # âš ï¸ æ³¨æ„ï¼šé€™è£¡å¿…é ˆæ­é…æ–°çš„ã€Œæ™ºæ…§åˆä½µ (Smart Merge)ã€è…³æœ¬ï¼Œæ‰ä¸æœƒæŠŠèˆŠæ¨™ç±¤æ´—æ‰
        echo "ğŸ”„ [5/6] æ•´åˆå…¨çŸ¥è³‡æ–™åº« (Merge Data)..."
        python merge_data.py || echo "âš ï¸ è³‡æ–™æ•´åˆå¤±æ•—..."

        # --- æ­¥é©Ÿ E: AI èªæ„å¢å¼· (Enrich) ---
        # âš ï¸ é—œéµé †åºï¼šå¿…é ˆåœ¨ Merge ç”¢ç”Ÿå®Œæ•´çš„ nihs_knowledge_full.json ä¹‹å¾ŒåŸ·è¡Œ
        # é€™æ¨£å®ƒæ‰èƒ½å¹«æ–°é€²ä¾†çš„è³‡æ–™åŠ ä¸Š tags
        echo "âœ¨ [6/6] åŸ·è¡Œ AI èªæ„å¢å¼· (Enrich Data)..."
        if [ -f "enrich_data.py" ]; then
          python enrich_data.py || echo "âš ï¸ èªæ„å¢å¼·å¤±æ•—ï¼Œä½†ä¿ç•™åŸå§‹è³‡æ–™ã€‚"
        else
          echo "âš ï¸ æ‰¾ä¸åˆ° enrich_data.pyï¼Œè·³éæ­¤æ­¥é©Ÿã€‚"
        fi

    # ---------------------------------------------------
    # 3. æäº¤èˆ‡åŒæ­¥ (å¼·æ•ˆæŠ—è¡çªç‰ˆ)
    # ---------------------------------------------------
    - name: æäº¤ä¸¦æ¨é€è®Šæ›´ (Robust Sync)
      run: |
        git config --global user.name "GitHub Action Bot"
        git config --global user.email "actions@github.com"
        
        # é å…ˆå®£å‘Šæ‹‰å–ç­–ç•¥ç‚º rebase
        git config pull.rebase true
        
        # 1. åŠ å…¥æ‰€æœ‰é—œéµæª”æ¡ˆ (å³ä½¿éœæ…‹æª”æ¡ˆæ²’è®Šï¼Œgit add ä¹Ÿä¸æœƒå ±éŒ¯)
        git add nihs_static_data_v43.json nihs_knowledge_full.json nihs_faq.json nihs_calendar.json || true
        
        timestamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        # 2. æª¢æŸ¥è®Šæ›´ä¸¦æäº¤
        if git commit -m "Auto-update data: ${timestamp}"; then
          echo "âœ… è³‡æ–™æœ‰è®Šå‹•ï¼Œæº–å‚™åŒæ­¥..."
          
          # 3. å…ˆæ‹‰å–é ç«¯æœ€æ–°è®Šæ›´ (Rebase)
          echo "ğŸ”„ åŸ·è¡Œ git pull --rebase..."
          git pull origin main --no-edit
          
          # 4. æ¨é€
          echo "ğŸš€ åŸ·è¡Œ git push..."
          if git push origin main; then
            echo "âœ… è³‡æ–™åº«å·²æˆåŠŸåŒæ­¥è‡³ GitHubï¼"
          else
            echo "âŒ æ¨é€å¤±æ•—ï¼Œè«‹æª¢æŸ¥ GitHub Action Logsã€‚"
            exit 1
          fi
        else
          echo "âš ï¸ è³‡æ–™å…§å®¹ç„¡è®Šæ›´ (å¯èƒ½æ˜¯é€±æœ«æˆ–ç„¡æ–°å…¬å‘Š)ï¼Œè·³éæ¨é€ã€‚"
        fi
