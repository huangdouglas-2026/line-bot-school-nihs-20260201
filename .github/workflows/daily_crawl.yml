name: æ¯æ—¥æ ¡åœ’è³‡æ–™æ›´æ–° (Daily Crawl)

# è¨­å®šè§¸ç™¼æ™‚æ©Ÿ
on:
  # 1. è‡ªå‹•æ’ç¨‹ï¼šæ¯å¤© UTC 19:00 (å°ç£æ™‚é–“å‡Œæ™¨ 03:00)
  schedule:
    - cron: '0 19 * * *'
  
  # 2. æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

# âš ï¸ é—œéµæ¬Šé™è¨­å®š
permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 pandas lxml playwright nest_asyncio google-genai pdfplumber
        playwright install chromium

    - name: Run Crawlers and Data Processing
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        echo "ğŸ•·ï¸ [1/5] åŸ·è¡Œéœæ…‹çˆ¬èŸ²..."
        python static_crawler_v43_recursive.py
        
        echo "ğŸ•·ï¸ [2/5] åŸ·è¡Œå‹•æ…‹å…¬å‘Šçˆ¬èŸ²..."
        python ultimate_bot_builder_v40_printHere.py
        
        echo "ğŸ§  [3/5] ç”Ÿæˆ FAQ é¡Œåº«..."
        python generate_faq.py
        
        echo "ğŸ“… [4/5] è§£æè¡Œäº‹æ›† PDF..."
        python generate_calendar.py
        
        echo "ğŸ”„ [5/5] æ•´åˆå…¨çŸ¥è³‡æ–™åº« (Apple Keynote Style Ready)..."
        python merge_data.py

    # ---------------------------------------------------
    # ä¿®æ­£å¾Œçš„æ­¥é©Ÿ 5: æª¢æŸ¥è®Šæ›´ä¸¦ä¸Šå‚³ (å¼·æ•ˆæŠ—è¡çªç‰ˆ)
    # ---------------------------------------------------
    - name: Commit and Push changes
      run: |
        git config --global user.name "GitHub Action Bot"
        git config --global user.email "actions@github.com"
        
        # 1. å°‡ç”¢å‡ºçš„ JSON æª”æ¡ˆåŠ å…¥è¿½è¹¤
        git add nihs_knowledge_full.json nihs_faq.json nihs_calendar.json || true
        
        timestamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        # 2. åªæœ‰åœ¨æœ‰è®Šå‹•æ™‚æ‰åŸ·è¡Œ Commit
        if git commit -m "Auto-update data: ${timestamp}"; then
          echo "âœ… æœ‰æ–°è³‡æ–™ï¼Œæº–å‚™åŒæ­¥é ç«¯..."
          
          # âš ï¸ã€æ ¸å¿ƒä¿®å¾©ã€‘è¨­å®šæ‹‰å–ç­–ç•¥ä¸¦åŸ·è¡Œ rebase
          # é€™æœƒè™•ç†ã€Œé ç«¯å·²æœ‰æ›´æ–°ã€çš„å•é¡Œ
          git pull --rebase origin main
          
          # 3. åŸ·è¡Œæ¨é€
          git push origin main
          echo "ğŸš€ è³‡æ–™åº«å·²æˆåŠŸåŒæ­¥è‡³ GitHubï¼"
        else
          echo "âš ï¸ è³‡æ–™æ²’æœ‰è®Šæ›´ï¼Œè·³éæ¨é€ã€‚"
        fi
