name: æ¯æ—¥æ ¡åœ’è³‡æ–™æ›´æ–° (Daily Crawl)

# è¨­å®šè§¸ç™¼æ™‚æ©Ÿ
on:
  # 1. è‡ªå‹•æ’ç¨‹ï¼šå°ç£æ™‚é–“å‡Œæ™¨ 03:00 (19:00 UTC)
  schedule:
    - cron: '0 19 * * *'
  
  # 2. æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

# âš ï¸ é‡è¦ï¼šè³¦äºˆå¯«å…¥æ¬Šé™ï¼Œé€™å° push å‹•ä½œè‡³é—œé‡è¦
permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: æª¢å‡ºå„²å­˜åº« (Checkout)
      uses: actions/checkout@v4
      with:
        # æŠ“å–å®Œæ•´ Git æ­·å²ç´€éŒ„ä»¥ç¢ºä¿ Rebase æˆåŠŸ
        fetch-depth: 0

    - name: è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: å®‰è£å¿…è¦å¥—ä»¶ (Dependencies)
      run: |
        python -m pip install --upgrade pip
        # ä¿®æ­£è™•ï¼šç¢ºä¿å®‰è£ google-generativeai ä»¥è§£æ±º ModuleNotFoundError
        pip install requests beautifulsoup4 pandas lxml playwright nest_asyncio google-genai google-generativeai pdfplumber
        playwright install chromium

    - name: åŸ·è¡Œçˆ¬èŸ²èˆ‡è³‡æ–™è™•ç†
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        echo "ğŸ•·ï¸ [1/5] åŸ·è¡Œéœæ…‹çˆ¬èŸ²..."
        python static_crawler_v43_recursive.py || echo "âš ï¸ éœæ…‹çˆ¬èŸ²ç™¼ç”Ÿç•°å¸¸ï¼Œç¹¼çºŒåŸ·è¡Œ..."
        
        echo "ğŸ•·ï¸ [2/5] åŸ·è¡Œå‹•æ…‹å…¬å‘Šçˆ¬èŸ²..."
        python ultimate_bot_builder_v40_printHere.py || echo "âš ï¸ å‹•æ…‹çˆ¬èŸ²ç™¼ç”Ÿç•°å¸¸ï¼Œç¹¼çºŒåŸ·è¡Œ..."
        
        echo "ğŸ§  [3/5] ç”Ÿæˆ FAQ é¡Œåº« (ä½¿ç”¨ Gemini)..."
        # æ­¤æ­¥é©Ÿè‹¥å‡ºéŒ¯é€šå¸¸æ˜¯ API Key æˆ–å¥—ä»¶å•é¡Œ
        python generate_faq.py || echo "âš ï¸ FAQ ç”Ÿæˆå¤±æ•—..."
        
        echo "ğŸ“… [4/5] è§£æè¡Œäº‹æ›† PDF..."
        python generate_calendar.py || echo "âš ï¸ è¡Œäº‹æ›†è§£æå¤±æ•—..."
        
        echo "ğŸ”„ [5/5] æ•´åˆå…¨çŸ¥è³‡æ–™åº«..."
        python merge_data.py || echo "âš ï¸ è³‡æ–™æ•´åˆå¤±æ•—..."

    # ---------------------------------------------------
    # å¼·æ•ˆæŠ—è¡çªæäº¤èˆ‡æ¨é€ (Robust Sync)
    # ---------------------------------------------------
    - name: æäº¤ä¸¦æ¨é€è®Šæ›´ (è§£æ±º Push Rejected)
      run: |
        git config --global user.name "GitHub Action Bot"
        git config --global user.email "actions@github.com"
        
        # 1. å®£å‘Šæ‹‰å–ç­–ç•¥ç‚º rebaseï¼Œé¿å…äº’å‹•æç¤ºå°è‡´å¡æ­»
        git config pull.rebase true
        
        # 2. å°‡ç”¢å‡ºçš„æ‰€æœ‰ JSON æª”æ¡ˆåŠ å…¥ Git æš«å­˜å€
        git add nihs_knowledge_full.json nihs_faq.json nihs_calendar.json nihs_static_data_v43.json || true
        
        timestamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        # 3. åªæœ‰åœ¨æœ‰è®Šå‹•æ™‚æ‰åŸ·è¡Œ Commit
        if git commit -m "Auto-update data: ${timestamp}"; then
          echo "âœ… æœ‰æ–°è³‡æ–™ï¼ŒåŸ·è¡ŒåŒæ­¥æµç¨‹..."
          
          # 4. ğŸ”¥ è§£æ±ºè¡çªé—œéµï¼šå…ˆæ‹‰å–é ç«¯æœ€æ–°è®Šæ›´ (è™•ç†æ‰‹å‹•ä¿®æ”¹ç¨‹å¼ç¢¼é€ æˆçš„è¡çª)
          git pull origin main --no-edit
          
          # 5. æ¨é€
          if git push origin main; then
            echo "ğŸš€ è³‡æ–™åº«å·²æˆåŠŸåŒæ­¥è‡³ GitHubï¼"
          else
            echo "âŒ æ¨é€ä»ç„¶å¤±æ•—ï¼Œè«‹æª¢æŸ¥ GitHub æ¬Šé™æˆ–æª”æ¡ˆè¡çªã€‚"
            exit 1
          fi
        else
          echo "âš ï¸ è³‡æ–™å…§å®¹ç„¡è®Šæ›´ï¼Œè·³éæ¨é€ã€‚"
        fi
